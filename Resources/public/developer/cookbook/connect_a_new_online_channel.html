<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Connect A New Online Channel &mdash; CampaignChain 1.0.0-alpha.3 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.0-alpha.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="CampaignChain 1.0.0-alpha.3 documentation" href="../../index.html" />
    <link rel="up" title="The Developer Cookbook" href="index.html" />
    <link rel="next" title="The Administrator Handbook" href="../../administrator/index.html" />
    <link rel="prev" title="The Developer Cookbook" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../administrator/index.html" title="The Administrator Handbook"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="The Developer Cookbook"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">CampaignChain 1.0.0-alpha.3 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">The Developer Cookbook</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="connect-a-new-online-channel">
<h1>Connect A New Online Channel<a class="headerlink" href="#connect-a-new-online-channel" title="Permalink to this headline">¶</a></h1>
<p>The tutorial will walk you through the process of adding support for a new
online channel - in this case, <a class="reference external" href="http://www.linkedin.com">LinkedIn</a> - to CampaignChain by creating and
programming the necessary modules and packaging them into a Symfony bundle.</p>
<p>The new LinkedIn bundle will include functionality to connect to a user&#8217;s
LinkedIn activity stream and post updates to it.</p>
<div class="section" id="assumptions-and-prerequisites">
<h2>Assumptions and Prerequisites<a class="headerlink" href="#assumptions-and-prerequisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>You have a <a class="reference external" href="http://symfony.com/doc/current/book/installation.html">Symfony environment</a> meeting all the system requirements.</li>
<li>You have a working <a class="reference internal" href="../../administrator/installation/dev.html"><em>CampaignChain development installation</em></a>.</li>
<li>You have a good understanding of the OAuth authentication process.</li>
<li>You have a reasonable understanding of the LinkedIn REST API.
<a class="reference external" href="https://developer.linkedin.com/rest">Learn more about the API</a>.</li>
<li>You have an application registered with LinkedIn and have obtained the
necessary keys. <a class="reference external" href="https://www.linkedin.com/secure/developer">Register your application</a>.</li>
</ul>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>To connect a new online channel through CampaignChain, here are the steps you will
follow:</p>
<ol class="arabic simple">
<li><a class="reference internal" href="#generate-channel-and-location-bundles">Generate Channel and Location bundles</a></li>
<li><a class="reference internal" href="#define-configuration-files-for-the-channel-and-location-bundles">Define configuration files for the Channel and Location bundles</a></li>
<li><a class="reference internal" href="#define-routes-for-your-channel-and-location-modules">Define routes for your Channel and Location modules</a></li>
<li><a class="reference internal" href="#create-channel-and-location-controllers-and-views">Create Channel and Location controllers and views</a></li>
<li><a class="reference internal" href="#add-a-channel-icon">Add a channel icon</a></li>
</ol>
<p>To enable activities and operations for the new channel, here are the steps
you will follow:</p>
<ol class="arabic simple">
<li><a class="reference internal" href="#generate-activity-and-operation-bundles">Generate Activity and Operation bundles</a></li>
<li><a class="reference internal" href="#define-configuration-files-for-the-activity-and-operation-bundles">Define configuration files for the Activity and Operation bundles</a></li>
<li><a class="reference internal" href="#understand-the-api-exposed-by-the-channel-you-re-connecting">Understand the API exposed by the channel you&#8217;re connecting</a></li>
<li><a class="reference internal" href="#create-entities-and-entity-managers-for-your-activities-and-operations">Create entities and entity managers for your Activities and Operations</a></li>
<li><a class="reference internal" href="#create-input-forms-and-connect-them-to-your-entities">Create input forms and connect them to your entities</a></li>
<li><a class="reference internal" href="#create-an-api-client-and-job-processor">Create an API client and job processor</a></li>
<li><a class="reference internal" href="#define-routes-for-your-activity-and-operation-modules">Define routes for your Activity and Operation modules</a></li>
<li><a class="reference internal" href="#create-an-activity-controller">Create an Activity controller</a></li>
</ol>
</div>
<div class="section" id="connect-channels-and-locations">
<h2>Connect Channels and Locations<a class="headerlink" href="#connect-channels-and-locations" title="Permalink to this headline">¶</a></h2>
<div class="section" id="generate-channel-and-location-bundles">
<span id="id1"></span><h3>1. Generate Channel and Location bundles<a class="headerlink" href="#generate-channel-and-location-bundles" title="Permalink to this headline">¶</a></h3>
<p>The first step is to create a bundle for the LinkedIn channel. In this case,
we&#8217;ll assume the organization name is Acme, and use this organization name
for the module namespaces.</p>
<p>The following commands walk you through the process. Note that you&#8217;re safe
using Symfony&#8217;s defaults for all interactive prompts except for certain items
shown below</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console generate:bundle
Bundle namespace: Acme/CampaignChain/Channel/LinkedInBundle
Configuration format <span class="o">(</span>yml, xml, php, or annotation<span class="o">)</span>: yml
Do you want to generate the whole directory structure <span class="o">[</span>no<span class="o">]</span>? yes
</pre></div>
</div>
<p>Symfony will now produce a new bundle containing stub code and files, in
the location <em>your-project/src/Acme/CampaignChain/Channel/LinkedInBundle</em>.
The name of the bundle will be AcmeCampaignChainChannelLinkedInBundle.</p>
<p>Follow the steps above to generate a similar bundle for a location in the
channel. In this tutorial, the location will be the user&#8217;s LinkedIn activity
stream. When creating this bundle, you will specify the bundle namespace as
Acme/CampaignChain/Location/LinkedInBundle. The new bundle will be created at
<em>your-project/src/Acme/CampaignChain/Channel/LinkedInBundle</em> with the name
AcmeCampaignChainLocationLinkedInBundle.</p>
</div>
<div class="section" id="create-configuration-files">
<span id="define-configuration-files-for-the-channel-and-location-bundles"></span><h3>2. Create Configuration Files<a class="headerlink" href="#create-configuration-files" title="Permalink to this headline">¶</a></h3>
<p>Every CampaignChain bundle needs two configuration files: <em>composer.json</em> and
<em>campaignchain.yml</em>. So the next step is to create these configuration files for
your Channel and Location bundles.</p>
<p>To begin, create the <em>composer.json</em> file for the Channel bundle:</p>
<div class="highlight-json"><div class="highlight"><pre> // src/Acme/CampaignChain/Channel/LinkedInBundle/composer.json
 {
   &quot;name&quot;: &quot;acme/channel-linkedin&quot;,
   &quot;description&quot;: &quot;Connect with LinkedIn&quot;,
   &quot;keywords&quot;: [&quot;linkedin&quot;,&quot;oauth&quot;],
   &quot;type&quot;: &quot;campaignchain-channel&quot;,
   &quot;homepage&quot;: &quot;http://example.ac.me&quot;,
   &quot;license&quot;: &quot;Proprietary&quot;,
   &quot;authors&quot;: [
       {
           &quot;name&quot;: &quot;John Doe&quot;,
           &quot;email&quot;: &quot;john@example.ac.me&quot;
       }
   ],
   &quot;require&quot;: {
       &quot;campaignchain/core&quot;: &quot;dev-master&quot;,
       &quot;campaignchain/security-authentication-client-oauth&quot;: &quot;dev-master&quot;
   }
}
</pre></div>
</div>
<p>The important point to note here is the <em>type</em> parameter, which specifies
the bundle type as &#8216;campaignchain-channel&#8217;.</p>
<p>You should also create a <em>composer.json</em> for the Location bundle, as shown
below:</p>
<div class="highlight-json"><div class="highlight"><pre>// src/Acme/CampaignChain/Location/LinkedInBundle/composer.json
{
   &quot;name&quot;: &quot;acme/location-linkedin&quot;,
   &quot;description&quot;: &quot;LinkedIn user stream.&quot;,
   &quot;keywords&quot;: [&quot;linkedin&quot;, &quot;user&quot;, &quot;stream&quot;],
   &quot;type&quot;: &quot;campaignchain-location&quot;,
   &quot;homepage&quot;: &quot;http://example.ac.me&quot;,
   &quot;license&quot;: &quot;Proprietary&quot;,
   &quot;authors&quot;: [
       {
           &quot;name&quot;: &quot;John Doe&quot;,
           &quot;email&quot;: &quot;john@example.ac.me&quot;
       }
   ],
   &quot;require&quot;: {
       &quot;acme/channel-linkedin&quot;: &quot;dev-master&quot;
   }
}
</pre></div>
</div>
<p>Notice again that the <em>type</em> parameter reflects the new bundle type - in
this case, &#8216;campaignchain-location&#8217; - and the <em>require</em> parameter specifies a
dependency on the previous Channel bundle, by using the name defined in
the Channel bundle&#8217;s <em>composer.json</em> file.</p>
<p>In addition to <em>composer.json</em>, every CampaignChain bundle must also include an
<em>campaignchain.yml</em> file, which CampaignChain uses to correctly wire the module(s) in
the bundle into the system.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Although an CampaignChain bundle can contain multiple modules, we&#8217;ll keep things
simple in this tutorial and assume that each bundle contains only a single
module.</p>
</div>
<p>Your next step is to define the Channel bundle&#8217;s <em>campaignchain.yml</em> file, which
specifies the display name for the LinkedIn Channel module, any routes used
by the module and any hooks. Here&#8217;s what the file looks like:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># src/Acme/CampaignChain/Channel/LinkedInBundle/campaignchain.yml</span>

<span class="l-Scalar-Plain">modules</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">acme-linkedin</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">display_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">LinkedIn</span>
    <span class="l-Scalar-Plain">routes</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">new</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">acme_campaignchain_channel_linkedin_create</span>
    <span class="l-Scalar-Plain">hooks</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">campaignchain-assignee</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>Following CampaignChain conventions, the Channel module name includes the vendor name
and a string that describes the purpose of the module - in this case,
&#8216;acme-linkedin&#8217;. The module configuration also specifies the name of the
Symfony route to be used when creating a new channel (you&#8217;ll define this
route and its associated view script in the next few steps) and any hooks
used by the module.</p>
<p>Once the Channel module is defined, the next step is to tell CampaignChain about
the locations supported by the channel. This is specified via the Location
bundle&#8217;s <em>campaignchain.yml</em> file, as shown below:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># src/Acme/CampaignChain/Location/LinkedInBundle/campaignchain.yml</span>

<span class="l-Scalar-Plain">modules</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">acme-linkedin-user</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">display_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">LinkedIn user stream</span>
</pre></div>
</div>
<p>This configuration informs CampaignChain about the location module representing
the LinkedIn user stream and specifies its display name in the CampaignChain GUI.
Note that as before, the Location module name contains the vendor name and a
brief descriptive string identifying the location.</p>
</div>
<div class="section" id="define-channel-routes">
<span id="define-routes-for-your-channel-and-location-modules"></span><h3>3. Define Channel Routes<a class="headerlink" href="#define-channel-routes" title="Permalink to this headline">¶</a></h3>
<p>In general, a Channel module should take care of creating a new location
and handling authentication between CampaignChain and the channel. This implies
that the Channel module should define two routes: one to create a new channel
(&#8216;new&#8217;) and one to handle authentication (&#8216;login&#8217;).</p>
<p>In the previous step, you specified the name for the Channel module&#8217;s &#8216;new&#8217; route.
Now, it&#8217;s time to follow through by actually defining the URLs for the &#8216;new&#8217; route
and the additional required &#8216;login&#8217; route, and their respective controller actions.</p>
<p>To do this, update the file
<em>your-project/src/Acme/CampaignChain/Channel/LinkedInBundle/Resources/config/routing.yml</em>
as shown below:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># src/Acme/CampaignChain/Channel/LinkedInBundle/Resources/config/routing.yml</span>

<span class="l-Scalar-Plain">acme_campaignchain_channel_linkedin_create</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">/channel/linkedin/create</span>
  <span class="l-Scalar-Plain">defaults</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">_controller</span><span class="p-Indicator">:</span> <span class="nv">AcmeCampaignChainChannelLinkedInBundle</span><span class="p-Indicator">:</span><span class="nv">LinkedIn</span><span class="p-Indicator">:</span><span class="nv">create</span> <span class="p-Indicator">}</span>

<span class="l-Scalar-Plain">acme_campaignchain_channel_linkedin_login</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">/channel/linkedin/create/login</span>
  <span class="l-Scalar-Plain">defaults</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">_controller</span><span class="p-Indicator">:</span> <span class="nv">AcmeCampaignChainChannelLinkedInBundle</span><span class="p-Indicator">:</span><span class="nv">LinkedIn</span><span class="p-Indicator">:</span><span class="nv">login</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can delete the default &#8216;hello&#8217; route added by the Symfony
bundle generator in the above file. Similarly, you can delete the default
&#8216;hello&#8217; route in the Location module&#8217;s <em>routing.xml</em> file, which can be found
at <em>your-project/src/Acme/CampaignChain/Location/LinkedInBundle/Resources/config/routing.yml</em>.</p>
</div>
</div>
<div class="section" id="add-controllers-and-views">
<span id="create-channel-and-location-controllers-and-views"></span><h3>4. Add Controllers and Views<a class="headerlink" href="#add-controllers-and-views" title="Permalink to this headline">¶</a></h3>
<p>Next, you&#8217;ll need to create views and controllers for the routes above.
First up, you&#8217;ll handle the &#8216;new&#8217; route, by creating a LinkedInController
with a <em>createAction()</em> method, as shown below.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/Acme/CampaignChain/Channel/LinkedInBundle/Controller/LinkedInController.php</span>

<span class="k">namespace</span> <span class="nx">Acme\CampaignChain\Channel\LinkedInBundle\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CampaignChain\CoreBundle\Entity\Location</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Acme\CampaignChain\Location\LinkedInBundle\Entity\LinkedInUser</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Controller\Controller</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Session\Session</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Request</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">LinkedInController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="no">RESOURCE_OWNER</span> <span class="o">=</span> <span class="s1">&#39;LinkedIn&#39;</span><span class="p">;</span>

   <span class="k">private</span> <span class="nv">$applicationInfo</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
       <span class="s1">&#39;key_labels&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;App Key&#39;</span><span class="p">),</span>
       <span class="s1">&#39;secret_labels&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;secret&#39;</span><span class="p">,</span> <span class="s1">&#39;App Secret&#39;</span><span class="p">),</span>
       <span class="s1">&#39;config_url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;https://www.linkedin.com/secure/developer&#39;</span><span class="p">,</span>
       <span class="s1">&#39;parameters&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
           <span class="s2">&quot;force_login&quot;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
       <span class="p">),</span>
   <span class="p">);</span>

   <span class="k">public</span> <span class="k">function</span> <span class="nf">createAction</span><span class="p">()</span>
   <span class="p">{</span>
       <span class="nv">$oauthApp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span>
         <span class="s1">&#39;campaignchain.security.authentication.client.oauth.application&#39;</span>
       <span class="p">);</span>
       <span class="nv">$application</span> <span class="o">=</span> <span class="nv">$oauthApp</span><span class="o">-&gt;</span><span class="na">getApplication</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">RESOURCE_OWNER</span><span class="p">);</span>

       <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$application</span><span class="p">){</span>
           <span class="k">return</span> <span class="nv">$oauthApp</span><span class="o">-&gt;</span><span class="na">newApplicationTpl</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">RESOURCE_OWNER</span><span class="p">,</span>
             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">applicationInfo</span><span class="p">);</span>
       <span class="p">}</span>
       <span class="k">else</span> <span class="p">{</span>
           <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span>
               <span class="s1">&#39;AcmeCampaignChainChannelLinkedInBundle:Create:index.html.twig&#39;</span><span class="p">,</span>
               <span class="k">array</span><span class="p">(</span>
                   <span class="s1">&#39;page_title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Connect with LinkedIn&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;app_id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$application</span><span class="o">-&gt;</span><span class="na">getKey</span><span class="p">(),</span>
               <span class="p">)</span>
           <span class="p">);</span>
       <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <em>createAction()</em> method wraps CampaignChain&#8217;s OAuth module and renders a splash
page asking the user to connect to the LinkedIn account by providing credentials
and granting permission to CampaignChain to access user data. This page is rendered
with the view script shown below:</p>
<div class="highlight-html+jinja"><div class="highlight"><pre># src/Acme/CampaignChain/Channel/LinkedInBundle/Resources/views/Create/index.html.twig

<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;CampaignChainCoreBundle:Base:base.html.twig&#39;</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}</span>
 <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;jumbotron&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;p&gt;</span>Connect to the LinkedIn account by logging in to LinkedIn. Your username
 and password will remain with LinkedIn and will not be stored in this
 application.<span class="nt">&lt;/p&gt;</span>
 <span class="nt">&lt;p&gt;&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary btn-lg&quot;</span> <span class="na">role=</span><span class="s">&quot;button&quot;</span>
 <span class="na">onclick=</span><span class="s">&quot;popupwindow(&#39;</span><span class="cp">{{</span> <span class="nv">path</span><span class="o">(</span><span class="s1">&#39;acme_campaignchain_channel_linkedin_login&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&#39;,</span>
<span class="s"> &#39;&#39;,600,600);&quot;</span><span class="nt">&gt;</span>Connect now<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
 <span class="nt">&lt;/div&gt;</span>

<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>
</div>
<p>Clicking the &#8220;Connect now&#8221; button in the above view activates the &#8216;login&#8217;
route defined earlier. You now need to write a corresponding controller
action to use the credentials entered by the user, attempt authentication
and if successful, add the location to the CampaignChain database for later use.</p>
<p>To simplify this task, CampaignChain provides a Location service and a Channel
Wizard which together encapsulate most of the functionality you will need.
The code below illustrates the typical process:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/Acme/CampaignChain/Channel/LinkedInBundle/Controller/LinkedInController.php</span>

<span class="k">namespace</span> <span class="nx">Acme\CampaignChain\Channel\LinkedInBundle\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CampaignChain\CoreBundle\Entity\Location</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Acme\CampaignChain\Location\LinkedInBundle\Entity\LinkedInUser</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Controller\Controller</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Session\Session</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Request</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">LinkedInController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>

   <span class="k">public</span> <span class="k">function</span> <span class="nf">loginAction</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">){</span>
           <span class="nv">$oauth</span> <span class="o">=</span>
             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span>
               <span class="s1">&#39;campaignchain.security.authentication.client.oauth.authentication&#39;</span>
             <span class="p">);</span>
           <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$oauth</span><span class="o">-&gt;</span><span class="na">authenticate</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">RESOURCE_OWNER</span><span class="p">,</span>
             <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">applicationInfo</span><span class="p">);</span>
           <span class="nv">$profile</span> <span class="o">=</span> <span class="nv">$oauth</span><span class="o">-&gt;</span><span class="na">getProfile</span><span class="p">();</span>

           <span class="k">if</span><span class="p">(</span><span class="nv">$status</span><span class="p">){</span>
               <span class="k">try</span> <span class="p">{</span>
                   <span class="nv">$repository</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>
                   <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">getConnection</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>

                   <span class="nv">$wizard</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain.core.channel.wizard&#39;</span><span class="p">);</span>
                   <span class="nv">$wizard</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">displayName</span><span class="p">);</span>

                   <span class="c1">// Get the location module.</span>
                   <span class="nv">$locationService</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain.core.location&#39;</span><span class="p">);</span>
                   <span class="nv">$locationModule</span> <span class="o">=</span> <span class="nv">$locationService</span><span class="o">-&gt;</span><span class="na">getLocationModule</span><span class="p">(</span>
                     <span class="s1">&#39;acme/location-linkedin&#39;</span><span class="p">,</span> <span class="s1">&#39;acme-linkedin-user&#39;</span><span class="p">);</span>

                   <span class="nv">$location</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Location</span><span class="p">();</span>
                   <span class="nv">$location</span><span class="o">-&gt;</span><span class="na">setIdentifier</span><span class="p">(</span><span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">identifier</span><span class="p">);</span>
                   <span class="nv">$location</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">displayName</span><span class="p">);</span>
                   <span class="nv">$location</span><span class="o">-&gt;</span><span class="na">setLocationModule</span><span class="p">(</span><span class="nv">$locationModule</span><span class="p">);</span>
                   <span class="nv">$location</span><span class="o">-&gt;</span><span class="na">setImage</span><span class="p">(</span><span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">photoURL</span><span class="p">);</span>
                   <span class="nv">$location</span><span class="o">-&gt;</span><span class="na">setURL</span><span class="p">(</span><span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">profileURL</span><span class="p">);</span>

                   <span class="nv">$wizard</span><span class="o">-&gt;</span><span class="na">addLocation</span><span class="p">(</span><span class="nv">$location</span><span class="o">-&gt;</span><span class="na">getIdentifier</span><span class="p">(),</span> <span class="nv">$location</span><span class="p">);</span>

                   <span class="nv">$channel</span> <span class="o">=</span> <span class="nv">$wizard</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">();</span>
                   <span class="nv">$wizard</span><span class="o">-&gt;</span><span class="na">end</span><span class="p">();</span>

                   <span class="nv">$oauth</span><span class="o">-&gt;</span><span class="na">setLocation</span><span class="p">(</span><span class="nv">$channel</span><span class="o">-&gt;</span><span class="na">getLocations</span><span class="p">()[</span><span class="mi">0</span><span class="p">]);</span>

                   <span class="nv">$linkedinUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LinkedInUser</span><span class="p">();</span>
                   <span class="nv">$linkedinUser</span><span class="o">-&gt;</span><span class="na">setLocation</span><span class="p">(</span><span class="nv">$channel</span><span class="o">-&gt;</span><span class="na">getLocations</span><span class="p">()[</span><span class="mi">0</span><span class="p">]);</span>
                   <span class="nv">$linkedinUser</span><span class="o">-&gt;</span><span class="na">setIdentifier</span><span class="p">(</span><span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">identifier</span><span class="p">);</span>
                   <span class="nv">$linkedinUser</span><span class="o">-&gt;</span><span class="na">setDisplayName</span><span class="p">(</span><span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">displayName</span><span class="p">);</span>
                   <span class="nv">$linkedinUser</span><span class="o">-&gt;</span><span class="na">setProfileImageURL</span><span class="p">(</span><span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">photoURL</span><span class="p">);</span>
                   <span class="nv">$linkedinUser</span><span class="o">-&gt;</span><span class="na">setProfileURL</span><span class="p">(</span><span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">profileURL</span><span class="p">);</span>

                   <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$linkedinUser</span><span class="p">);</span>
                   <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

                   <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">getConnection</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>

                   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getFlashBag</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span>
                       <span class="s1">&#39;success&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;The LinkedIn location &lt;a href=&quot;#&quot;&gt;&#39;</span><span class="o">.</span>
                       <span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">displayName</span><span class="o">.</span><span class="s1">&#39;&lt;/a&gt; was connected</span>
<span class="s1">                       successfully.&#39;</span>
                   <span class="p">);</span>
               <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
                   <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">getConnection</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">rollback</span><span class="p">();</span>
                   <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
               <span class="p">}</span>
           <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="c1">// A channel already exists that has been connected</span>
               <span class="c1">// with this Facebook account</span>
               <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getFlashBag</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span>
                   <span class="s1">&#39;warning&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;A location has already been connected for this LinkedIn account.&#39;</span>
               <span class="p">);</span>
           <span class="p">}</span>

       <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span>
           <span class="s1">&#39;AcmeCampaignChainChannelLinkedInBundle:Create:login.html.twig&#39;</span><span class="p">,</span>
           <span class="k">array</span><span class="p">(</span>
               <span class="s1">&#39;redirect&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span><span class="s1">&#39;campaignchain_core_channel&#39;</span><span class="p">)</span>
           <span class="p">)</span>
       <span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The first few lines of the <em>loginAction()</em> action method use CampaignChain&#8217;s OAuth
module to authenticate against the remote service. If authentication is
successful, the OAuth object&#8217;s <em>getProfile()</em> method returns the profile of
the authenticated user. This location now needs to be added to CampaignChain&#8217;s
database.</p>
<p>To accomplish this, the action method first creates a new Channel Wizard
object, which is a convenience object that makes it easy to connect the new
location to the channel and save it to CampaignChain&#8217;s database. The Channel Wizard
is invoked as a Symfony service. The Channel Wizard is also assigned a name
using its <em>setName()</em> method; this could be a fixed name, or based on input
entered by the user (although you&#8217;d need to provide a form field in the view
to accept this input).</p>
<p>Every channel must have at least one location. The action method then calls
CampaignChain&#8217;s Location service to identify the Location module. The Location
bundle&#8217;s name and unique module identifier play a critical role in helping
the Channel Wizard correctly identify and store the location so that CampaignChain
can correctly generate routes for the location.</p>
<p>The method initializes a new Location object using the information from
the returned user profile, and attaches this Location object to the channel
using the channel wizard&#8217;s <em>addLocation()</em> method. The information about the
new location is saved to the database using the channel wizard&#8217;s <em>persist()</em>
method.</p>
<p>Since every location is typically associated with a user, it makes sense
to also store information about the user in the CampaignChain database. The
typical properties you&#8217;d want to store are the user identifier, first name,
last name, email address, profile URL and profile image URL, plus any properties
specific to the channel you&#8217;re connecting.</p>
<p>The action method above uses a LinkedInUser object, implemented as a Doctrine
entity with properties for the user identifier, first name, last name, email
address, LinkedIn profile URL and LinkedIn profile image URL. The code for
this LinkedInUser entity is as follows:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/Acme/CampaignChain/Location/LinkedInBundle/Entity/LinkedInUser.php</span>

<span class="k">namespace</span> <span class="nx">Acme\CampaignChain\Location\LinkedInBundle\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Entity</span>
<span class="sd"> * @ORM\Table(name=&quot;acme_location_linkedin_user&quot;)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">LinkedInUser</span>
<span class="p">{</span>
   <span class="sd">/**</span>
<span class="sd">    * @ORM\Column(type=&quot;integer&quot;)</span>
<span class="sd">    * @ORM\Id</span>
<span class="sd">    * @ORM\GeneratedValue(strategy=&quot;AUTO&quot;)</span>
<span class="sd">    */</span>
   <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>

   <span class="sd">/**</span>
<span class="sd">    * @ORM\OneToOne(targetEntity=&quot;CampaignChain\CoreBundle\Entity\Location&quot;,</span>
<span class="sd">    *   cascade={&quot;persist&quot;})</span>
<span class="sd">    */</span>
   <span class="k">protected</span> <span class="nv">$location</span><span class="p">;</span>

   <span class="sd">/**</span>
<span class="sd">    * @ORM\Column(type=&quot;string&quot;, length=255, unique=true)</span>
<span class="sd">    */</span>
   <span class="k">protected</span> <span class="nv">$identifier</span><span class="p">;</span>

   <span class="sd">/**</span>
<span class="sd">    * @ORM\Column(type=&quot;string&quot;, length=255, name=&quot;display_name&quot;)</span>
<span class="sd">    */</span>
   <span class="k">protected</span> <span class="nv">$displayName</span><span class="p">;</span>

   <span class="sd">/**</span>
<span class="sd">    * @ORM\Column(type=&quot;string&quot;, length=255, name=&quot;first_name&quot;, nullable=true)</span>
<span class="sd">    */</span>
   <span class="k">protected</span> <span class="nv">$firstName</span><span class="p">;</span>

   <span class="sd">/**</span>
<span class="sd">    * @ORM\Column(type=&quot;string&quot;, length=255, name=&quot;last_name&quot;, nullable=true)</span>
<span class="sd">    */</span>
   <span class="k">protected</span> <span class="nv">$lastName</span><span class="p">;</span>

   <span class="sd">/**</span>
<span class="sd">    * @ORM\Column(type=&quot;string&quot;, length=255, nullable=true)</span>
<span class="sd">    */</span>
   <span class="k">protected</span> <span class="nv">$email</span><span class="p">;</span>

   <span class="sd">/**</span>
<span class="sd">    * @ORM\Column(type=&quot;string&quot;, length=255, name=&quot;profile_url&quot;, nullable=true)</span>
<span class="sd">    */</span>
   <span class="k">protected</span> <span class="nv">$profileURL</span><span class="p">;</span>

   <span class="sd">/**</span>
<span class="sd">    * @ORM\Column(type=&quot;string&quot;, length=255, name=&quot;profile_image_url&quot;,</span>
<span class="sd">    *   nullable=true)</span>
<span class="sd">    */</span>
   <span class="k">protected</span> <span class="nv">$profileImageURL</span><span class="p">;</span>


   <span class="sd">/**</span>
<span class="sd">    * Get id</span>
<span class="sd">    *</span>
<span class="sd">    * @return integer</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span>
   <span class="p">{</span>
       <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
   <span class="p">}</span>


   <span class="sd">/**</span>
<span class="sd">    * Set identifier</span>
<span class="sd">    *</span>
<span class="sd">    * @param string $identifier</span>
<span class="sd">    * @return LinkedInUser</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">setIdentifier</span><span class="p">(</span><span class="nv">$identifier</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">identifier</span> <span class="o">=</span> <span class="nv">$identifier</span><span class="p">;</span>

       <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Get identifier</span>
<span class="sd">    *</span>
<span class="sd">    * @return string</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">getIdentifier</span><span class="p">()</span>
   <span class="p">{</span>
       <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">identifier</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Set displayName</span>
<span class="sd">    *</span>
<span class="sd">    * @param string $displayName</span>
<span class="sd">    * @return LinkedInUser</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">setDisplayName</span><span class="p">(</span><span class="nv">$displayName</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">displayName</span> <span class="o">=</span> <span class="nv">$displayName</span><span class="p">;</span>

       <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Get displayName</span>
<span class="sd">    *</span>
<span class="sd">    * @return string</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">getDisplayName</span><span class="p">()</span>
   <span class="p">{</span>
       <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">displayName</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Set firstName</span>
<span class="sd">    *</span>
<span class="sd">    * @param string $firstName</span>
<span class="sd">    * @return LinkedInUser</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">setFirstName</span><span class="p">(</span><span class="nv">$firstName</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">firstName</span> <span class="o">=</span> <span class="nv">$firstName</span><span class="p">;</span>

       <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Get firstName</span>
<span class="sd">    *</span>
<span class="sd">    * @return string</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">getFirstName</span><span class="p">()</span>
   <span class="p">{</span>
       <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">firstName</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Set lastName</span>
<span class="sd">    *</span>
<span class="sd">    * @param string $lastName</span>
<span class="sd">    * @return LinkedInUser</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">setLastName</span><span class="p">(</span><span class="nv">$lastName</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lastName</span> <span class="o">=</span> <span class="nv">$lastName</span><span class="p">;</span>

       <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Get lastName</span>
<span class="sd">    *</span>
<span class="sd">    * @return string</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">getLastName</span><span class="p">()</span>
   <span class="p">{</span>
       <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lastName</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Set email</span>
<span class="sd">    *</span>
<span class="sd">    * @param string $email</span>
<span class="sd">    * @return LinkedInUser</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">setEmail</span><span class="p">(</span><span class="nv">$email</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">email</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span>

       <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Get email</span>
<span class="sd">    *</span>
<span class="sd">    * @return string</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">getEmail</span><span class="p">()</span>
   <span class="p">{</span>
       <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">email</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Set profileURL</span>
<span class="sd">    *</span>
<span class="sd">    * @param string $profileURL</span>
<span class="sd">    * @return LinkedInUser</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">setProfileURL</span><span class="p">(</span><span class="nv">$profileURL</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">profileURL</span> <span class="o">=</span> <span class="nv">$profileURL</span><span class="p">;</span>

       <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Get profileURL</span>
<span class="sd">    *</span>
<span class="sd">    * @return string</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">getProfileURL</span><span class="p">()</span>
   <span class="p">{</span>
       <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">profileURL</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Set profileImageURL</span>
<span class="sd">    *</span>
<span class="sd">    * @param string $profileImageURL</span>
<span class="sd">    * @return LinkedInUser</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">setProfileImageURL</span><span class="p">(</span><span class="nv">$profileImageURL</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">profileImageURL</span> <span class="o">=</span> <span class="nv">$profileImageURL</span><span class="p">;</span>

       <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Get profileImageURL</span>
<span class="sd">    *</span>
<span class="sd">    * @return string</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">getProfileImageURL</span><span class="p">()</span>
   <span class="p">{</span>
       <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">profileImageURL</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Set location</span>
<span class="sd">    *</span>
<span class="sd">    * @param \CampaignChain\CoreBundle\Entity\Location $location</span>
<span class="sd">    * @return LinkedInUser</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">setLocation</span><span class="p">(</span><span class="nx">\CampaignChain\CoreBundle\Entity\Location</span>
     <span class="nv">$location</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">location</span> <span class="o">=</span> <span class="nv">$location</span><span class="p">;</span>

       <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="sd">/**</span>
<span class="sd">    * Get location</span>
<span class="sd">    *</span>
<span class="sd">    * @return \CampaignChain\CoreBundle\Entity\Location</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">getLocation</span><span class="p">()</span>
   <span class="p">{</span>
       <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">location</span><span class="p">;</span>
   <span class="p">}</span>


   <span class="sd">/**</span>
<span class="sd">    * Constructor</span>
<span class="sd">    */</span>
   <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
   <span class="p">{</span>

   <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="add-a-channel-icon">
<span id="id2"></span><h3>5. Add a Channel Icon<a class="headerlink" href="#add-a-channel-icon" title="Permalink to this headline">¶</a></h3>
<p>Every Channel module should include a channel icon image, for easy identification
within the CampaignChain GUI. In most cases, the channel you&#8217;re trying to connect
to will provide a logo image, so all that&#8217;s really needed is to resize it to
16x16 pixels and save it in PNG format.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Remember to read the channel&#8217;s terms of use for its images, ensure that
your usage of the image is compliant and provide an image credit,
link and/or attribution as needed.</p>
</div>
<p>For the LinkedIn Channel module created in this tutorial, the channel icon
image should be saved to <em>your-project/src/Acme/CampaignChain/Location/LinkedInBundle/Resources/public/images/icons/16x16/linkedin.png</em>.
The name of the image (&#8216;linkedin&#8217;) should match the descriptive string used
in the bundle name (&#8216;acme/channel-linkedin&#8217;)</p>
<p>At this point, your Channel and Location bundles are complete.</p>
</div>
</div>
<div class="section" id="define-activities-and-operations">
<h2>Define Activities and Operations<a class="headerlink" href="#define-activities-and-operations" title="Permalink to this headline">¶</a></h2>
<p>With the Channel and Location defined, the next step is to define the
Activities and Operations possible. To keep things simple, we&#8217;ll assume
that only a single Activity is required: sharing news on the user&#8217;s LinkedIn
stream. This will be accomplished using LinkedIn&#8217;s Share API, which makes it
possible to add posts to a user&#8217;s LinkedIn social stream using REST.</p>
<div class="section" id="generate-activity-and-operation-bundles">
<span id="id3"></span><h3>1. Generate Activity and Operation bundles<a class="headerlink" href="#generate-activity-and-operation-bundles" title="Permalink to this headline">¶</a></h3>
<p>The first step here is again to create bundles for the Activity and Operation.
Remember that every Activity must have at least one Operation. In this
case, since only one Operation is needed, the Activity is equal to the Operation
(and you&#8217;ll see further along how to let CampaignChain know this).</p>
<p>The command to create a new bundle is explained earlier. Here it is again:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>php app/console generate:bundle
</pre></div>
</div>
<p>When creating the Activity bundle, you will specify the bundle namespace as
Acme/CampaignChain/Activity/LinkedInBundle. The new bundle will be created at
<em>your-project/src/Acme/CampaignChain/Activity/LinkedInBundle</em> with the name
AcmeCampaignChainActivityLinkedInBundle.</p>
<p>When creating the Operation bundle, you will specify the bundle namespace as
Acme/CampaignChain/Operation/LinkedInBundle. The new bundle will be created at
<em>your-project/src/Acme/CampaignChain/Operation/LinkedInBundle</em> with the name
AcmeCampaignChainOperationLinkedInBundle.</p>
</div>
<div class="section" id="define-configuration-files-for-the-activity-and-operation-bundles">
<span id="id4"></span><h3>2. Create Configuration Files<a class="headerlink" href="#define-configuration-files-for-the-activity-and-operation-bundles" title="Permalink to this headline">¶</a></h3>
<p>The next step is to create configuration files for
your Activity and Operation bundles.</p>
<p>To begin, create the <em>composer.json</em> file for the Activity bundle:</p>
<div class="highlight-json"><div class="highlight"><pre>// src/Acme/CampaignChain/Activity/LinkedInBundle/composer.json
{
    &quot;name&quot;: &quot;acme/activity-linkedin&quot;,
    &quot;description&quot;: &quot;Post a news update on a LinkedIn stream.&quot;,
    &quot;keywords&quot;: [&quot;linkedin&quot;,&quot;news&quot;],
    &quot;type&quot;: &quot;campaignchain-activity&quot;,
    &quot;homepage&quot;: &quot;http://example.ac.me&quot;,
    &quot;license&quot;: &quot;Proprietary&quot;,
    &quot;authors&quot;: [
        {
            &quot;name&quot;: &quot;John Doe&quot;,
            &quot;email&quot;: &quot;john@example.ac.me&quot;
        }
    ],
    &quot;require&quot;: {
        &quot;campaignchain/core&quot;: &quot;dev-master&quot;,
        &quot;campaignchain/location-linkedin&quot;: &quot;dev-master&quot;,
        &quot;campaignchain/operation-linkedin&quot;: &quot;dev-master&quot;,
        &quot;campaignchain/hook-due&quot;: &quot;dev-master&quot;
    }
}
</pre></div>
</div>
<p>You will notice that the <em>type</em> parameter specifies the bundle type as
&#8216;campaignchain-activity&#8217;. Notice also that the <em>require</em> parameter includes dependencies
for the corresponding Operation bundle, as well as CampaignChain&#8217;s due hook.
The latter is needed so that activities and operations can be scheduled for
automatic execution at specific times in the future.</p>
<p>You should also create a <em>composer.json</em> for the Operation bundle, as shown
below:</p>
<div class="highlight-json"><div class="highlight"><pre>// src/Acme/CampaignChain/Operation/LinkedInBundle/composer.json
{
    &quot;name&quot;: &quot;acme/operation-linkedin&quot;,
    &quot;description&quot;: &quot;Collection of various LinkedIn operations.&quot;,
    &quot;keywords&quot;: [&quot;linkedin&quot;,&quot;operation&quot;],
    &quot;type&quot;: &quot;campaignchain-operation&quot;,
    &quot;homepage&quot;: &quot;http://example.ac.me&quot;,
    &quot;license&quot;: &quot;Proprietary&quot;,
    &quot;authors&quot;: [
        {
            &quot;name&quot;: &quot;John Doe&quot;,
            &quot;email&quot;: &quot;john@example.ac.me&quot;
        }
    ]
}
</pre></div>
</div>
<p>By now, it should be clear that the <em>type</em> parameter for Operation bundles
must hold the value &#8216;campaignchain-operation&#8217;...and that&#8217;s clearly seen in the
above definition as well.</p>
<p>Your next step is to define the Activity bundle&#8217;s <em>campaignchain.yml</em> file, which
specifies the display name for the LinkedIn Activity module, any routes used
by the module and any hooks. Here&#8217;s what the file looks like:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># src/Acme/CampaignChain/Activity/LinkedInBundle/campaignchain.yml</span>

<span class="l-Scalar-Plain">modules</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">acme-linkedin-share-news-item</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">display_name</span><span class="p-Indicator">:</span> <span class="s">&#39;Share</span><span class="nv"> </span><span class="s">News&#39;</span>
    <span class="l-Scalar-Plain">channels</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">acme/channel-linkedin/acme-linkedin</span>
    <span class="l-Scalar-Plain">routes</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">new</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">acme_campaignchain_activity_linkedin_share_news_item_new</span>
        <span class="l-Scalar-Plain">edit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">acme_campaignchain_activity_linkedin_share_news_item_edit</span>
        <span class="l-Scalar-Plain">edit_modal</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">acme_campaignchain_activity_linkedin_share_news_item_edit_modal</span>
        <span class="l-Scalar-Plain">edit_api</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">acme_campaignchain_activity_linkedin_share_news_item_edit_api</span>
    <span class="l-Scalar-Plain">hooks</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">campaignchain-due</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>Following CampaignChain conventions, the Activity module name includes the vendor
name and a string that describes the purpose of the module - in this case,
&#8216;acme-linkedin-share-news-item&#8217;. The module configuration also specifies the
display name to be used in the CampaignChain GUI, the names of the Symfony route
to be used when creating or editing activities, and any hooks used by the
module.</p>
<p>An important addition in the Activity bundle&#8217;s <em>campaignchain.yml</em> file is the
<em>channels</em> parameter, which specifies the link between the channel and the
activity. The format of the value is the Channel bundle name, followed by
the Channel module name, separated by slashes. In this case, the value
&#8216;acme/channel-linkedin/acme-linkedin&#8217; points to the Channel bundle created
earlier (&#8216;acme/channel-linkedin&#8217;) and the Channel module within it
(&#8216;acme-linkedin&#8217;).</p>
<p>Once the Activity module is defined, the next step is to tell CampaignChain about
the operations supported by the activity. This is specified via the Operation
bundle&#8217;s <em>campaignchain.yml</em> file, as shown below:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># src/Acme/CampaignChain/Operation/LinkedInBundle/campaignchain.yml</span>

<span class="l-Scalar-Plain">modules</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">acme-linkedin-share-news-item</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">display_name</span><span class="p-Indicator">:</span> <span class="s">&#39;Share</span><span class="nv"> </span><span class="s">News&#39;</span>
    <span class="l-Scalar-Plain">owns_location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
    <span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">job</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">acme.operation.linkedin.job.share_news_item</span>
</pre></div>
</div>
<p>This configuration informs CampaignChain about the Operation module representing
the news sharing operation for LinkedIn. As before, the Operation module
name contains the vendor name and a brief descriptive string identifying
the operation.</p>
<p>Since the Operation module will also create a new Location (in this case,
a new post in the LinkedIn stream which is accessible directly via a unique
URL), it&#8217;s important to tell CampaignChain that the Operation will own the new
Location, via the <em>owns_location</em> parameter.</p>
<p>Finally, since the Operation needs to expose a Job (which will be run by
CampaignChain&#8217;s global scheduler and which we&#8217;ll define further along), the
configuration specifies the name for this job service so CampaignChain can easily
invoke it.</p>
</div>
<div class="section" id="understand-the-linkedin-share-api">
<span id="understand-the-api-exposed-by-the-channel-you-re-connecting"></span><h3>3. Understand the LinkedIn Share API<a class="headerlink" href="#understand-the-linkedin-share-api" title="Permalink to this headline">¶</a></h3>
<p>Now that the basics of the bundles are defined, let&#8217;s look more closely at
the news sharing operation to be implemented. Review the image below, which
displays a typical news item in a LinkedIn user&#8217;s stream.</p>
<img alt="../../_images/linkedin-news-item.png" src="../../_images/linkedin-news-item.png" />
<p>As you can see, a LinkedIn news item has a number of elements:</p>
<ul class="simple">
<li>A user message</li>
<li>A link to an external page</li>
<li>A link title</li>
<li>A link description</li>
<li>A link image</li>
</ul>
<p>The most efficient way to post such a news item to a LinkedIn user&#8217;s stream
programmatically is with the LinkedIn Share API. Using this API involves
sending an authenticated POST request to the API endpoint
<a class="reference external" href="https://api.linkedin.com/v1/people/~/shares">https://api.linkedin.com/v1/people/~/shares</a>, and transmitting an XML document
like the one shown below in the body of the POST request:</p>
<div class="highlight-xml"><div class="highlight"><pre>&lt;share&gt;
  &lt;comment&gt;The White House is awesome!&lt;/comment&gt;
  &lt;content&gt;
    &lt;title&gt;The White House - President Barack Obama&lt;/title&gt;
    &lt;description&gt;Opening the Doors to the White House&lt;/description&gt;
    &lt;submitted-url&gt;http://whitehouse.gov&lt;/submitted-url&gt;
    &lt;submitted-image-url&gt;
      https://media.licdn.com/media-proxy/ext?w=180&amp;h=110&amp;f=c&amp;hash=6VU6...
    &lt;/submitted-image-url&gt;
  &lt;/content&gt;
  &lt;visibility&gt;
    &lt;code&gt;anyone&lt;/code&gt;
  &lt;/visibility&gt;
&lt;/share&gt;
</pre></div>
</div>
<p>It should be easy to understand the correspondence between the XML elements
and the news item components.</p>
<p>The response to a successful request is returned in XML and looks something like this:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&#39;1.0&#39;?&gt;</span>
<span class="nt">&lt;update&gt;</span>
  <span class="nt">&lt;update-key&gt;</span>KEY-1111-2222-33333-KEY<span class="nt">&lt;/update-key&gt;</span>
  <span class="nt">&lt;update-url&gt;</span>https://www.linkedin.com/updates?scope=111111111...<span class="nt">&lt;/update-url&gt;</span>
<span class="nt">&lt;/update&gt;</span>
</pre></div>
</div>
<p>To implement the news sharing operating in CampaignChain, therefore, you&#8217;ll first
create a NewsItem entity representing a LinkedIn news item, and a service
manager to work with that entity.</p>
<p>You&#8217;ll also need an input form, so the user can populate the entity, and a
client to take care of the nitty-gritty of generating and transmitting a
correctly-formatted POST request to the LinkedIn API.</p>
<p>Finally, because one of CampaignChain&#8217;s core capabilities is the ability to schedule
activities and operations ahead of time, you&#8217;ll need to store newly-created
NewsItem entities in the CampaignChain database, and implement a job to transmit
them to LinkedIn at the appropriate time.</p>
</div>
<div class="section" id="create-an-entity-and-entity-manager">
<span id="create-entities-and-entity-managers-for-your-activities-and-operations"></span><h3>4. Create An Entity and Entity Manager<a class="headerlink" href="#create-an-entity-and-entity-manager" title="Permalink to this headline">¶</a></h3>
<p>In this step, you will create an entity to represent a LinkedIn news item. The code for
this NewsItem entity is as follows and it should be saved to
<em>your-project/src/Acme/CampaignChain/Operation/LinkedInBundle/Entity/NewsItem.php</em>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// src/Acme/CampaignChain/Operation/LinkedInBundle/Entity/NewsItem.php</span>

<span class="k">namespace</span> <span class="nx">Acme\CampaignChain\Operation\LinkedInBundle\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Entity</span>
<span class="sd"> * @ORM\Table(name=&quot;acme_operation_linkedin_news_item&quot;)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">NewsItem</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;integer&quot;)</span>
<span class="sd">     * @ORM\Id</span>
<span class="sd">     * @ORM\GeneratedValue(strategy=&quot;AUTO&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\OneToOne(targetEntity=&quot;CampaignChain\CoreBundle\Entity\Operation&quot;,</span>
<span class="sd">     *   cascade={&quot;persist&quot;})</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$operation</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;text&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$message</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;text&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$linkTitle</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;text&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$linkDescription</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * URL included within the share content</span>
<span class="sd">     * @ORM\Column(type=&quot;string&quot;, length=255, name=&quot;linkUrl&quot;, nullable=true)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$linkUrl</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * direct URL to the share</span>
<span class="sd">     * @ORM\Column(type=&quot;string&quot;, length=255, nullable=true)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$url</span><span class="p">;</span>


    <span class="sd">/**</span>
<span class="sd">     * Get id</span>
<span class="sd">     *</span>
<span class="sd">     * @return integer</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Set message</span>
<span class="sd">     *</span>
<span class="sd">     * @param string $message</span>
<span class="sd">     * @return Status</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setMessage</span><span class="p">(</span><span class="nv">$message</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">message</span> <span class="o">=</span> <span class="nv">$message</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Get message</span>
<span class="sd">     *</span>
<span class="sd">     * @return string</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getMessage</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Set title</span>
<span class="sd">     *</span>
<span class="sd">     * @param string $linkTitle</span>
<span class="sd">     * @return Status</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setLinkTitle</span><span class="p">(</span><span class="nv">$linkTitle</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">linkTitle</span> <span class="o">=</span> <span class="nv">$linkTitle</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Get title</span>
<span class="sd">     *</span>
<span class="sd">     * @return string</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getLinkTitle</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">linkTitle</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Set description</span>
<span class="sd">     *</span>
<span class="sd">     * @param string $linkDescription</span>
<span class="sd">     * @return Status</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setLinkDescription</span><span class="p">(</span><span class="nv">$linkDescription</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">linkDescription</span> <span class="o">=</span> <span class="nv">$linkDescription</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Get description</span>
<span class="sd">     *</span>
<span class="sd">     * @return string</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getLinkDescription</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">linkDescription</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Set submit URL</span>
<span class="sd">     *</span>
<span class="sd">     * @param string $linkUrl</span>
<span class="sd">     * @return Status</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setLinkUrl</span><span class="p">(</span><span class="nv">$linkUrl</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">linkUrl</span> <span class="o">=</span> <span class="nv">$linkUrl</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Get submit URL</span>
<span class="sd">     *</span>
<span class="sd">     * @return string</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getLinkUrl</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">linkUrl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Set url</span>
<span class="sd">     *</span>
<span class="sd">     * @param string $url</span>
<span class="sd">     * @return Status</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUrl</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">url</span> <span class="o">=</span> <span class="nv">$url</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Get url</span>
<span class="sd">     *</span>
<span class="sd">     * @return string</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getUrl</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">url</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Set operation</span>
<span class="sd">     *</span>
<span class="sd">     * @param \CampaignChain\CoreBundle\Entity\Operation $operation</span>
<span class="sd">     * @return Status</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setOperation</span><span class="p">(</span><span class="nx">\CampaignChain\CoreBundle\Entity\Operation</span>
      <span class="nv">$operation</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">operation</span> <span class="o">=</span> <span class="nv">$operation</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Get operation</span>
<span class="sd">     *</span>
<span class="sd">     * @return \CampaignChain\CoreBundle\Entity\Operation</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getOperation</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">operation</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As you can see, the entity includes proeprties corresponding to those expected
by the LinkedIn Share API (the image URL field is omitted for simplicity),
as well as some properties needed by CampaignChain.</p>
<p>You will also need an entity service manager, which will retrieve an instance
of the entity by its identifier. Here&#8217;s the code, which should be saved to
<em>your-project/src/Acme/CampaignChain/Operation/LinkedInBundle/EntityService/NewsItem.php</em>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// src/Acme/CampaignChain/Operation/LinkedInBundle/EntityService/NewsItem.php</span>

<span class="k">namespace</span> <span class="nx">Acme\CampaignChain\Operation\LinkedInBundle\EntityService</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityManager</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">NewsItem</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$em</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">EntityManager</span> <span class="nv">$em</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">em</span> <span class="o">=</span> <span class="nv">$em</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getNewsItemByOperation</span><span class="p">(</span><span class="nv">$id</span><span class="p">){</span>
        <span class="nv">$newsitem</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">em</span>
            <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;AcmeCampaignChainOperationLinkedInBundle:NewsItem&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">findOneByOperation</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$newsitem</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span>
                <span class="s1">&#39;No news item found by operation id &#39;</span><span class="o">.</span><span class="nv">$id</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$newsitem</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <em>getNewsItemByOperation()</em> method takes care of retrieving a specific
news item using its unique identifier in the database.</p>
<p>This is also a good point to update the Operation module&#8217;s list of exposed
services to include the new entity service manager. To do this, update the
file at <em>your-project/src/Acme/CampaignChain/Operation/LinkedInBundle/Resources/config/services.yml</em>
with the following information.</p>
<div class="highlight-yaml"><div class="highlight"><pre># src/Acme/CampaignChain/Operation/LinkedInBundle/Resources/config/services.yml

parameters:

services:
    acme.operation.linkedin.news_item:
        class: Acme\CampaignChain\Operation\LinkedInBundle\EntityService\NewsItem
        arguments: [ @doctrine.orm.entity_manager ]
</pre></div>
</div>
</div>
<div class="section" id="create-an-input-form-for-entity-data">
<span id="create-input-forms-and-connect-them-to-your-entities"></span><h3>5. Create an Input Form for Entity Data<a class="headerlink" href="#create-an-input-form-for-entity-data" title="Permalink to this headline">¶</a></h3>
<p>With the entity created, the next step is to provide an input form that will
be rendered by the CampaignChain user interface. This form will be used when setting
up a new LinkedIn news item, and the fields in the form must therefore correspond
with the properties of the NewsItem entity.</p>
<p>The easiest way to create the form is by using Symfony&#8217;s Form component and
FormBuilder interface. The following code, which should be saved to
<em>your-project/src/Acme/CampaignChain/Operation/LinkedInBundle/Form/Type/ShareNewsItemOperationType.php</em>,
illustrates how to do this.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// src/Acme/CampaignChain/Operation/LinkedInBundle/Form/Type/ShareNewsItemOperationType.php</span>

<span class="k">namespace</span> <span class="nx">Acme\CampaignChain\Operation\LinkedInBundle\Form\Type</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Component\Form\AbstractType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\FormBuilderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\OptionsResolver\OptionsResolverInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\DependencyInjection\ContainerInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityManager</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ShareNewsItemOperationType</span> <span class="k">extends</span> <span class="nx">AbstractType</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$newsitem</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$view</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$em</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$container</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">EntityManager</span> <span class="nv">$em</span><span class="p">,</span> <span class="nx">ContainerInterface</span> <span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">em</span> <span class="o">=</span> <span class="nv">$em</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setNewsItem</span><span class="p">(</span><span class="nv">$newsitem</span><span class="p">){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">newsitem</span> <span class="o">=</span> <span class="nv">$newsitem</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setView</span><span class="p">(</span><span class="nv">$view</span><span class="p">){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">view</span> <span class="o">=</span> <span class="nv">$view</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">buildForm</span><span class="p">(</span><span class="nx">FormBuilderInterface</span> <span class="nv">$builder</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$builder</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;property_path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span>
                <span class="s1">&#39;label&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Message&#39;</span><span class="p">,</span>
                <span class="s1">&#39;attr&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                    <span class="s1">&#39;placeholder&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Add message...&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;max_length&#39;</span> <span class="o">=&gt;</span> <span class="mi">200</span>
                <span class="p">)</span>
            <span class="p">));</span>
        <span class="nv">$builder</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;linkTitle&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;property_path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;linkTitle&#39;</span><span class="p">,</span>
                <span class="s1">&#39;label&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Title of page being shared&#39;</span><span class="p">,</span>
                <span class="s1">&#39;attr&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                    <span class="s1">&#39;placeholder&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Add title...&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;max_length&#39;</span> <span class="o">=&gt;</span> <span class="mi">140</span>
                <span class="p">)</span>
            <span class="p">));</span>
        <span class="nv">$builder</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;textarea&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;property_path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;linkDescription&#39;</span><span class="p">,</span>
                <span class="s1">&#39;label&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Description of page being shared&#39;</span><span class="p">,</span>
                <span class="s1">&#39;attr&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                    <span class="s1">&#39;placeholder&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Add description...&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;max_length&#39;</span> <span class="o">=&gt;</span> <span class="mi">300</span>
                <span class="p">)</span>
            <span class="p">));</span>
        <span class="nv">$builder</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;submitUrl&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;property_path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;linkUrl&#39;</span><span class="p">,</span>
                <span class="s1">&#39;label&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;URL of page being shared&#39;</span><span class="p">,</span>
                <span class="s1">&#39;attr&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                    <span class="s1">&#39;placeholder&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Add URL...&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;max_length&#39;</span> <span class="o">=&gt;</span> <span class="mi">255</span>
                <span class="p">)</span>
            <span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setDefaultOptions</span><span class="p">(</span><span class="nx">OptionsResolverInterface</span> <span class="nv">$resolver</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$defaults</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;data_class&#39;</span> <span class="o">=&gt;</span>
              <span class="s1">&#39;CampaignChain\Operation\LinkedInBundle\Entity\NewsItem&#39;</span><span class="p">,</span>
        <span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">newsitem</span><span class="p">){</span>
            <span class="nv">$defaults</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">newsitem</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$resolver</span><span class="o">-&gt;</span><span class="na">setDefaults</span><span class="p">(</span><span class="nv">$defaults</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;acme_operation_linkedin_share_news_item&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The main work here is done by the <em>buildForm()</em> method, which takes care of
creating the necessary form fields, and the <em>setDefaultOptions()</em> method,
which links the data entered into the form with the NewsItem entity created earlier.</p>
</div>
<div class="section" id="create-an-api-client-and-job-processor">
<span id="id5"></span><h3>6. Create an API Client and Job Processor<a class="headerlink" href="#create-an-api-client-and-job-processor" title="Permalink to this headline">¶</a></h3>
<p>In the previous steps, you enabled the user to enter details of a new LinkedIn
news item into a form and have that data saved to the CampaignChain database. The
next step is to massage that data into the format needed by the LinkedIn API
and then transfer it to the API in an authenticated request.</p>
<p>To accomplish this task, it is necessary to create an HTTP client object
which will ease communication with the LinkedIn API. CampaignChain already comes
with an OAuth client, which you used previously in your LinkedIn Channel module.
You can use this client&#8217;s built-in functionality to take care of most of the
authentication tasks.</p>
<p>To do this, go back to your Channel module and add the following LinkedInClient
object to it, at the location <em>your-project/src/Acme/CampaignChain/Channel/LinkedInBundle/REST/LinkedInClient.php</em>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// src/Acme/CampaignChain/Channel/LinkedInBundle/REST/LinkedInClient.php</span>

<span class="k">namespace</span> <span class="nx">Acme\CampaignChain\Channel\LinkedInBundle\REST</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Session\Session</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Guzzle\Http\Client</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Guzzle\Plugin\Oauth\OauthPlugin</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">LinkedInClient</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">RESOURCE_OWNER</span> <span class="o">=</span> <span class="s1">&#39;LinkedIn&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">BASE_URL</span>   <span class="o">=</span> <span class="s1">&#39;https://api.linkedin.com/v1&#39;</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$container</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setContainer</span><span class="p">(</span><span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">connectByActivity</span><span class="p">(</span><span class="nv">$activity</span><span class="p">){</span>
        <span class="nv">$oauthApp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span>
          <span class="s1">&#39;campaignchain.security.authentication.client.oauth.application&#39;</span>
        <span class="p">);</span>
        <span class="nv">$application</span> <span class="o">=</span> <span class="nv">$oauthApp</span><span class="o">-&gt;</span><span class="na">getApplication</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">RESOURCE_OWNER</span><span class="p">);</span>

        <span class="nv">$oauthToken</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span>
          <span class="s1">&#39;campaignchain.security.authentication.client.oauth.token&#39;</span>
        <span class="p">);</span>
        <span class="nv">$token</span> <span class="o">=</span> <span class="nv">$oauthToken</span><span class="o">-&gt;</span><span class="na">getToken</span><span class="p">(</span><span class="nv">$activity</span><span class="o">-&gt;</span><span class="na">getLocation</span><span class="p">());</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">(</span>
          <span class="nv">$application</span><span class="o">-&gt;</span><span class="na">getKey</span><span class="p">(),</span>
          <span class="nv">$application</span><span class="o">-&gt;</span><span class="na">getSecret</span><span class="p">(),</span>
          <span class="nv">$token</span><span class="o">-&gt;</span><span class="na">getAccessToken</span><span class="p">(),</span>
          <span class="nv">$token</span><span class="o">-&gt;</span><span class="na">getTokenSecret</span><span class="p">()</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">connect</span><span class="p">(</span><span class="nv">$appKey</span><span class="p">,</span> <span class="nv">$appSecret</span><span class="p">,</span> <span class="nv">$accessToken</span><span class="p">,</span> <span class="nv">$tokenSecret</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">BASE_URL</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
            <span class="nv">$oauth</span>  <span class="o">=</span> <span class="k">new</span> <span class="nx">OauthPlugin</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;consumer_key&#39;</span>    <span class="o">=&gt;</span> <span class="nv">$appKey</span><span class="p">,</span>
                <span class="s1">&#39;consumer_secret&#39;</span> <span class="o">=&gt;</span> <span class="nv">$appSecret</span><span class="p">,</span>
                <span class="s1">&#39;token&#39;</span>           <span class="o">=&gt;</span> <span class="nv">$accessToken</span><span class="p">,</span>
                <span class="s1">&#39;token_secret&#39;</span>    <span class="o">=&gt;</span> <span class="nv">$tokenSecret</span><span class="p">,</span>
            <span class="p">));</span>

            <span class="k">return</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">addSubscriber</span><span class="p">(</span><span class="nv">$oauth</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">ClientErrorResponseException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getRequest</span><span class="p">();</span>
            <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getResponse</span><span class="p">();</span>
            <span class="nb">print_r</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">ServerErrorResponseException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getRequest</span><span class="p">();</span>
            <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getResponse</span><span class="p">();</span>
            <span class="nb">print_r</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">BadResponseException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getRequest</span><span class="p">();</span>
            <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getResponse</span><span class="p">();</span>
            <span class="nb">print_r</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">){</span>
          <span class="nb">print_r</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The two important values set in this client are the constants at the top:
the RESOURCE_OWNER constant specifies the owning channel, which is then used
to retrieve the keys and secrets needed for an authenticated API connection,
and the BASE_URL constant specifies the base URL for all API requests.</p>
<p>You will also need to update the Channel module&#8217;s list of exposed services
to include the new client. To do this, update the file at
<em>your-project/src/Acme/CampaignChain/Channel/LinkedInBundle/Resources/config/services.yml</em>
with the following information.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># src/Acme/CampaignChain/Channel/LinkedInBundle/Resources/config/services.yml</span>

<span class="l-Scalar-Plain">parameters</span><span class="p-Indicator">:</span>

<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">acme.channel.linkedin.rest.client</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">class</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Acme\CampaignChain\Channel\LinkedInBundle\REST\LinkedInClient</span>
        <span class="l-Scalar-Plain">calls</span><span class="p-Indicator">:</span>
            <span class="p-Indicator">-</span> <span class="p-Indicator">[</span><span class="nv">setContainer</span><span class="p-Indicator">,</span> <span class="p-Indicator">[</span><span class="s">&quot;@service_container&quot;</span><span class="p-Indicator">]]</span>
</pre></div>
</div>
<p>You&#8217;ll notice that this client object merely takes care of connecting and
authenticating against the LinkedIn API. It doesn&#8217;t actually take care of
creating and sending a POST request to the Share API. That task is handled
by a separate Job object, which should be created within your Operation module at
<em>your-project/src/Acme/CampaignChain/Operation/LinkedInBundle/Job/ShareNewsItem.php</em>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// src/Acme/CampaignChain/Operation/LinkedInBundle/Job/ShareNewsItem.php</span>

<span class="k">namespace</span> <span class="nx">Acme\CampaignChain\Operation\LinkedInBundle\Job</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CampaignChain\CoreBundle\Entity\Action</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityManager</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">CampaignChain\CoreBundle\Entity\Medium</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">CampaignChain\CoreBundle\Job\JobServiceInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Response</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ShareNewsItem</span> <span class="k">implements</span> <span class="nx">JobServiceInterface</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$em</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$container</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$message</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$linkTitle</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$linkDescription</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$linkUrl</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">EntityManager</span> <span class="nv">$em</span><span class="p">,</span> <span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">em</span> <span class="o">=</span> <span class="nv">$em</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(</span><span class="nv">$operationId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$newsitem</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">em</span>
          <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;AcmeCampaignChainOperationLinkedInBundle:NewsItem&#39;</span><span class="p">)</span>
          <span class="o">-&gt;</span><span class="na">findOneByOperation</span><span class="p">(</span><span class="nv">$operationId</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$newsitem</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span>
              <span class="s1">&#39;No news item found for an operation with ID: &#39;</span><span class="o">.</span><span class="nv">$operationId</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Process the link URL to append the Tracking ID attached for</span>
        <span class="c1">// call to action tracking.</span>
        <span class="nv">$ctaService</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain.core.cta&#39;</span><span class="p">);</span>
        <span class="nv">$newsitem</span><span class="o">-&gt;</span><span class="na">setLinkUrl</span><span class="p">(</span>
            <span class="nv">$ctaService</span><span class="o">-&gt;</span><span class="na">processCTAs</span><span class="p">(</span>
                <span class="nv">$newsitem</span><span class="o">-&gt;</span><span class="na">getLinkUrl</span><span class="p">(),</span>
                <span class="nv">$newsitem</span><span class="o">-&gt;</span><span class="na">getOperation</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">getContent</span><span class="p">()</span>
        <span class="p">);</span>

        <span class="nv">$client</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;acme.channel.linkedin.rest.client&#39;</span><span class="p">);</span>
        <span class="nv">$connection</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">connectByActivity</span><span class="p">(</span>
          <span class="nv">$newsitem</span><span class="o">-&gt;</span><span class="na">getOperation</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getActivity</span><span class="p">()</span>
        <span class="p">);</span>

        <span class="nv">$xmlBody</span> <span class="o">=</span> <span class="s2">&quot;&lt;share&gt;&lt;comment&gt;&quot;</span> <span class="o">.</span> <span class="nv">$newsitem</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span> <span class="o">.</span>
          <span class="s2">&quot;&lt;/comment&gt;&lt;content&gt;&lt;title&gt;&quot;</span> <span class="o">.</span> <span class="nv">$newsitem</span><span class="o">-&gt;</span><span class="na">getLinkTitle</span><span class="p">()</span> <span class="o">.</span>
          <span class="s2">&quot;&lt;/title&gt;&lt;description&gt;&quot;</span> <span class="o">.</span> <span class="nv">$newsitem</span><span class="o">-&gt;</span><span class="na">getLinkDescription</span><span class="p">()</span> <span class="o">.</span>
          <span class="s2">&quot;&lt;/description&gt;&lt;submitted-url&gt;&quot;</span> <span class="o">.</span> <span class="nv">$newsitem</span><span class="o">-&gt;</span><span class="na">getLinkUrl</span><span class="p">()</span> <span class="o">.</span>
          <span class="s2">&quot;&lt;/submitted-url&gt;&lt;/content&gt;&lt;visibility&gt;&lt;code&gt;anyone&lt;/code&gt;&lt;/visibility&gt;&lt;/share&gt;&quot;</span><span class="p">;</span>

        <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span>
          <span class="s1">&#39;people/~/shares&#39;</span><span class="p">,</span>
          <span class="k">array</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;application/xml&#39;</span><span class="p">)),</span>
          <span class="nv">$xmlBody</span>
        <span class="p">);</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">xml</span><span class="p">();</span>

        <span class="nv">$newsitemUrl</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="p">{</span><span class="s1">&#39;update-url&#39;</span><span class="p">};</span>
        <span class="nv">$newsitemId</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="p">{</span><span class="s1">&#39;update-key&#39;</span><span class="p">};</span>

        <span class="nv">$newsitem</span><span class="o">-&gt;</span><span class="na">setUrl</span><span class="p">(</span><span class="nv">$newsitemUrl</span><span class="p">);</span>
        <span class="c1">// Set Operation to closed.</span>
        <span class="nv">$newsitem</span><span class="o">-&gt;</span><span class="na">getOperation</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">setStatus</span><span class="p">(</span><span class="nx">Action</span><span class="o">::</span><span class="na">STATUS_CLOSED</span><span class="p">);</span>

        <span class="nv">$location</span> <span class="o">=</span> <span class="nv">$newsitem</span><span class="o">-&gt;</span><span class="na">getOperation</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getLocations</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nv">$location</span><span class="o">-&gt;</span><span class="na">setIdentifier</span><span class="p">(</span><span class="nv">$newsitemId</span><span class="p">);</span>
        <span class="nv">$location</span><span class="o">-&gt;</span><span class="na">setURL</span><span class="p">(</span><span class="nv">$newsitemUrl</span><span class="p">);</span>
        <span class="nv">$location</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="nv">$status</span><span class="o">-&gt;</span><span class="na">getOperation</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">());</span>
        <span class="nv">$location</span><span class="o">-&gt;</span><span class="na">setStatus</span><span class="p">(</span><span class="nx">Medium</span><span class="o">::</span><span class="na">STATUS_ACTIVE</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">em</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">message</span> <span class="o">=</span> <span class="s1">&#39;The message &quot;&#39;</span><span class="o">.</span><span class="nv">$newsitem</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;&quot; with the ID &quot;&#39;</span><span class="o">.</span>
          <span class="nv">$newsitemId</span><span class="o">.</span><span class="s1">&#39;&quot; has been posted on LinkedIn. See it on LinkedIn:</span>
<span class="s1">          &lt;a href=&quot;&#39;</span><span class="o">.</span><span class="nv">$newsitemUrl</span><span class="o">.</span><span class="s1">&#39;&quot;&gt;&#39;</span><span class="o">.</span><span class="nv">$newsitemUrl</span><span class="o">.</span><span class="s1">&#39;&lt;/a&gt;&#39;</span><span class="p">;</span>

        <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="na">STATUS_OK</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getMessage</span><span class="p">(){</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A Job object is always part of an Operation module and it is called as necessary
to perform the corresponding operation. It should implement the JobServiceInterface,
which mandates an <em>execute()</em> method which is called when the job is executed.</p>
<p>If you look into the <em>execute()</em> method above, you&#8217;ll see that it begins by
retrieving the required news item from the CampaignChain database (using the news
item&#8217;s identifier). Then it passes the link URL to CampaignChain&#8217;s CTA service so that
CampaignChain can store the URL as a Call to Action and track it. It also invokes the
LinkedIn client created earlier as a Symfony service and uses the client to
authenticate against the LinkedIn API.</p>
<p>The next step is to generate an XML document containing the details of the
news item to be posted, in the format expected by the LinkedIn API. This
XML document is then transmitted to the API endpoint <a class="reference external" href="https://api.linkedin.com/v1/people/~/shares">https://api.linkedin.com/v1/people/~/shares</a>
in a POST request using the client&#8217;s inherited <em>post()</em> method. The XML response
is converted to a SimpleXML object for easy processing.</p>
<p>The XML response contains two useful pieces of information: the LinkedIn
identifier for the news item, and the direct URL to it. The remainder of
the <em>execute()</em> method is concerned with saving this information to the CampaignChain
database, updating the status of the operation and presenting a success message
to the user.</p>
<p>Given that the shared news has a dedicated URL on Linkedin, a new Location is
being created. That way, the new posting will also be included in CampaignChain&#8217;s
Call-to-Action tracking.</p>
<p>Finally, update the Activity module&#8217;s list of exposed services to include
the new job. Remember that the name you assign to this job service must match
the name specified for the job in the Activity module&#8217;s <em>campaignchain.yml</em> file.</p>
<p>To do this, update the file at
<em>your-project/src/Acme/CampaignChain/Activity/LinkedInBundle/Resources/config/services.yml</em>
so it now looks like the following.</p>
<div class="highlight-yaml"><div class="highlight"><pre># src/Acme/CampaignChain/Activity/LinkedInBundle/Resources/config/services.yml

parameters:

services:
    acme.operation.linkedin.job.share_news_item:
        class: Acme\CampaignChain\Operation\LinkedInBundle\Job\ShareNewsItem
        arguments: [ @doctrine.orm.entity_manager, @service_container ]
    acme.operation.linkedin.news_item:
            class: Acme\CampaignChain\Operation\LinkedInBundle\EntityService\NewsItem
            arguments: [ @doctrine.orm.entity_manager ]
</pre></div>
</div>
</div>
<div class="section" id="create-activity-and-operation-routes">
<span id="define-routes-for-your-activity-and-operation-modules"></span><h3>7. Create Activity and Operation Routes<a class="headerlink" href="#create-activity-and-operation-routes" title="Permalink to this headline">¶</a></h3>
<p>In general, an Activity module should specify the routes for creating and
editing operations. This implies that the Activity module should define
four routes:</p>
<ul class="simple">
<li>A route to create a new activity (&#8216;new&#8217;)</li>
<li>A route to edit an existing activity (&#8216;edit&#8217;)</li>
<li>A route to edit an existing activity in the campaign timeline&#8217;s pop-up/lightbox
view (&#8216;edit_modal&#8217;)</li>
<li>A route for the submit action of the pop-up/lightbox view in the campaign
timeline (&#8216;edit_api&#8217;)</li>
</ul>
<p>When defining the <em>campaignchain.yml</em> file for the Activity module, you specified
names for all these routes. The next step is to connect those names with
Symfony controllers and actions.</p>
<p>To do this, update the file
<em>your-project/src/Acme/CampaignChain/Activity/LinkedInBundle/Resources/config/routing.yml</em>
as shown below:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># src/Acme/CampaignChain/Activity/LinkedInBundle/Resources/config/routing.yml</span>

<span class="l-Scalar-Plain">acme_campaignchain_activity_linkedin_share_news_item_new</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">/activity/linkedin/share-news-item/new</span>
  <span class="l-Scalar-Plain">defaults</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">_controller</span><span class="p-Indicator">:</span> <span class="nv">AcmeCampaignChainActivityLinkedInBundle</span><span class="p-Indicator">:</span><span class="nv">ShareNewsItem</span><span class="p-Indicator">:</span><span class="nv">new</span> <span class="p-Indicator">}</span>

<span class="l-Scalar-Plain">acme_campaignchain_activity_linkedin_share_news_item_edit</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">/activity/linkedin/share-news-item/{id}/edit</span>
  <span class="l-Scalar-Plain">defaults</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">_controller</span><span class="p-Indicator">:</span> <span class="nv">AcmeCampaignChainActivityLinkedInBundle</span><span class="p-Indicator">:</span><span class="nv">ShareNewsItem</span><span class="p-Indicator">:</span><span class="nv">edit</span> <span class="p-Indicator">}</span>

<span class="l-Scalar-Plain">acme_campaignchain_activity_linkedin_share_news_item_edit_modal</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">/modal/activity/linkedin/share-news-item/{id}/edit</span>
  <span class="l-Scalar-Plain">defaults</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">_controller</span><span class="p-Indicator">:</span> <span class="nv">AcmeCampaignChainActivityLinkedInBundle</span><span class="p-Indicator">:</span><span class="nv">ShareNewsItem</span><span class="p-Indicator">:</span><span class="nv">editModal</span> <span class="p-Indicator">}</span>

<span class="l-Scalar-Plain">acme_campaignchain_activity_linkedin_share_news_item_edit_api</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">/api/private/activity/linkedin/share-news-item/byactivity/{id}/edit</span>
  <span class="l-Scalar-Plain">defaults</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">_controller</span><span class="p-Indicator">:</span> <span class="nv">AcmeCampaignChainActivityLinkedInBundle</span><span class="p-Indicator">:</span><span class="nv">ShareNewsItem</span><span class="p-Indicator">:</span><span class="nv">editApi</span> <span class="p-Indicator">}</span>
  <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">expose</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can delete the default &#8216;hello&#8217; route added by the Symfony
bundle generator in the above file. Similarly, you can delete the default
&#8216;hello&#8217; route in the Operation module&#8217;s <em>routing.xml</em> file, which can be found
at <em>your-project/src/Acme/CampaignChain/Operation/LinkedInBundle/Resources/config/routing.yml</em>.</p>
</div>
</div>
<div class="section" id="create-an-activity-controller">
<span id="id6"></span><h3>8. Create an Activity Controller<a class="headerlink" href="#create-an-activity-controller" title="Permalink to this headline">¶</a></h3>
<p>Next, you&#8217;ll need to create views and controllers for the routes above.
First up, you&#8217;ll handle the &#8216;new&#8217; route, by creating a controller
with a <em>createAction()</em> method, as shown below.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// src/Acme/CampaignChain/Activity/LinkedInBundle/Controller/ShareNewsItemController.php</span>

<span class="k">namespace</span> <span class="nx">Acme\CampaignChain\Activity\LinkedInBundle\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CampaignChain\CoreBundle\Entity\Location</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">CampaignChain\CoreBundle\Entity\Medium</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Controller\Controller</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Session\Session</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">CampaignChain\CoreBundle\Entity\Operation</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Response</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Acme\CampaignChain\Operation\LinkedInBundle\Form\Type\ShareNewsItemOperationType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Serializer\Serializer</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Serializer\Encoder\JsonEncoder</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Serializer\Normalizer\GetSetMethodNormalizer</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ShareNewsItemController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">BUNDLE_NAME</span> <span class="o">=</span> <span class="s1">&#39;acme/activity-linkedin&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">MODULE_IDENTIFIER</span> <span class="o">=</span> <span class="s1">&#39;acme-linkedin-share-news-item&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">OPERATION_IDENTIFIER</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">MODULE_IDENTIFIER</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">newAction</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$wizard</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain.core.activity.wizard&#39;</span><span class="p">);</span>
        <span class="nv">$campaign</span> <span class="o">=</span> <span class="nv">$wizard</span><span class="o">-&gt;</span><span class="na">getCampaign</span><span class="p">();</span>
        <span class="nv">$activity</span> <span class="o">=</span> <span class="nv">$wizard</span><span class="o">-&gt;</span><span class="na">getActivity</span><span class="p">();</span>

        <span class="nv">$activity</span><span class="o">-&gt;</span><span class="na">setEqualsOperation</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

        <span class="nv">$activityType</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain.core.form.type.activity&#39;</span><span class="p">);</span>
        <span class="nv">$activityType</span><span class="o">-&gt;</span><span class="na">setBundleName</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">BUNDLE_NAME</span><span class="p">);</span>
        <span class="nv">$activityType</span><span class="o">-&gt;</span><span class="na">setModuleIdentifier</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">MODULE_IDENTIFIER</span><span class="p">);</span>
        <span class="nv">$shareNewsItemOperation</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ShareNewsItemOperationType</span><span class="p">(</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">(),</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;service_container&#39;</span><span class="p">));</span>
        <span class="nv">$operationForms</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;identifier&#39;</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">OPERATION_IDENTIFIER</span><span class="p">,</span>
            <span class="s1">&#39;form&#39;</span> <span class="o">=&gt;</span> <span class="nv">$shareNewsItemOperation</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;LinkedIn Message&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="nv">$activityType</span><span class="o">-&gt;</span><span class="na">setOperationForms</span><span class="p">(</span><span class="nv">$operationForms</span><span class="p">);</span>
        <span class="nv">$activityType</span><span class="o">-&gt;</span><span class="na">setCampaign</span><span class="p">(</span><span class="nv">$campaign</span><span class="p">);</span>

        <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createForm</span><span class="p">(</span><span class="nv">$activityType</span><span class="p">,</span> <span class="nv">$activity</span><span class="p">);</span>

        <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">handleRequest</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$activity</span> <span class="o">=</span> <span class="nv">$wizard</span><span class="o">-&gt;</span><span class="na">end</span><span class="p">();</span>

            <span class="c1">// Get the operation module.</span>
            <span class="nv">$operationService</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain.core.operation&#39;</span><span class="p">);</span>
            <span class="nv">$operationModule</span> <span class="o">=</span> <span class="nv">$operationService</span><span class="o">-&gt;</span><span class="na">getOperationModule</span><span class="p">(</span>
                <span class="s1">&#39;acme/operation-linkedin&#39;</span><span class="p">,</span>
                <span class="s1">&#39;acme-linkedin-share-news-item&#39;</span>
            <span class="p">);</span>

            <span class="c1">// The activity equals the operation.</span>
            <span class="c1">// Thus, we create a new operation with the same data.</span>
            <span class="nv">$operation</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Operation</span><span class="p">();</span>
            <span class="nv">$operation</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="nv">$activity</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">());</span>
            <span class="nv">$operation</span><span class="o">-&gt;</span><span class="na">setActivity</span><span class="p">(</span><span class="nv">$activity</span><span class="p">);</span>
            <span class="nv">$activity</span><span class="o">-&gt;</span><span class="na">addOperation</span><span class="p">(</span><span class="nv">$operation</span><span class="p">);</span>
            <span class="nv">$operationModule</span><span class="o">-&gt;</span><span class="na">addOperation</span><span class="p">(</span><span class="nv">$operation</span><span class="p">);</span>
            <span class="nv">$operation</span><span class="o">-&gt;</span><span class="na">setOperationModule</span><span class="p">(</span><span class="nv">$operationModule</span><span class="p">);</span>

            <span class="c1">// The Operation creates a Location, i.e. the post</span>
            <span class="c1">// will be accessible through a URL after publishing.</span>
            <span class="c1">// Get the location module for the user stream.</span>
            <span class="nv">$locationService</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain.core.location&#39;</span><span class="p">);</span>
            <span class="nv">$locationModule</span> <span class="o">=</span> <span class="nv">$locationService</span><span class="o">-&gt;</span><span class="na">getLocationModule</span><span class="p">(</span>
                <span class="s1">&#39;acme/location-linkedin&#39;</span><span class="p">,</span>
                <span class="s1">&#39;acme-linkedin-user&#39;</span>
            <span class="p">);</span>

            <span class="nv">$location</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Location</span><span class="p">();</span>
            <span class="nv">$location</span><span class="o">-&gt;</span><span class="na">setLocationModule</span><span class="p">(</span><span class="nv">$locationModule</span><span class="p">);</span>
            <span class="nv">$location</span><span class="o">-&gt;</span><span class="na">setParent</span><span class="p">(</span><span class="nv">$activity</span><span class="o">-&gt;</span><span class="na">getLocation</span><span class="p">());</span>
            <span class="nv">$location</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="nv">$activity</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">());</span>
            <span class="nv">$location</span><span class="o">-&gt;</span><span class="na">setStatus</span><span class="p">(</span><span class="nx">Medium</span><span class="o">::</span><span class="na">STATUS_UNPUBLISHED</span><span class="p">);</span>
            <span class="nv">$location</span><span class="o">-&gt;</span><span class="na">setOperation</span><span class="p">(</span><span class="nv">$operation</span><span class="p">);</span>
            <span class="nv">$operation</span><span class="o">-&gt;</span><span class="na">addLocation</span><span class="p">(</span><span class="nv">$location</span><span class="p">);</span>

            <span class="c1">// Get the status data from request.</span>
            <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">OPERATION_IDENTIFIER</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">();</span>
            <span class="c1">// Link the status with the operation.</span>
            <span class="nv">$status</span><span class="o">-&gt;</span><span class="na">setOperation</span><span class="p">(</span><span class="nv">$operation</span><span class="p">);</span>

            <span class="nv">$repository</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>

            <span class="c1">// Make sure that data stays intact by using transactions.</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">getConnection</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>

                <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$activity</span><span class="p">);</span>
                <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$status</span><span class="p">);</span>

                <span class="c1">// We need the activity ID for storing the hooks. Hence we must flush here.</span>
                <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

                <span class="nv">$hookService</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain.core.hook&#39;</span><span class="p">);</span>
                <span class="nv">$activity</span> <span class="o">=</span> <span class="nv">$hookService</span><span class="o">-&gt;</span><span class="na">processHooks</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">BUNDLE_NAME</span><span class="p">,</span>
                  <span class="nx">self</span><span class="o">::</span><span class="na">MODULE_IDENTIFIER</span><span class="p">,</span> <span class="nv">$activity</span><span class="p">,</span> <span class="nv">$form</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>

                <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

                <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">getConnection</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">getConnection</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">rollback</span><span class="p">();</span>
                <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getFlashBag</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span>
                <span class="s1">&#39;success&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Your new LinkedIn activity &lt;a href=&quot;&#39;</span><span class="o">.</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span>
                  <span class="s1">&#39;campaignchain_core_activity_edit&#39;</span><span class="p">,</span>
                  <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$activity</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">())</span>
                <span class="p">)</span><span class="o">.</span>
                <span class="s1">&#39;&quot;&gt;&#39;</span><span class="o">.</span><span class="nv">$activity</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span>
                <span class="s1">&#39;&lt;/a&gt; was created successfully.&#39;</span>
            <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain_hook_campaignchain_due&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">has</span><span class="p">(</span><span class="s1">&#39;execution_choice&#39;</span><span class="p">)</span>
              <span class="o">&amp;&amp;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain_hook_campaignchain_due&#39;</span><span class="p">)</span>
                      <span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;execution_choice&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;now&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$job</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;acme.operation.linkedin.job.share_news_item&#39;</span><span class="p">);</span>
                <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$operation</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">());</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span>
              <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span><span class="s1">&#39;campaignchain_core_activities&#39;</span><span class="p">)</span>
            <span class="p">);</span>

        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span>
            <span class="s1">&#39;CampaignChainCoreBundle:Base:new.html.twig&#39;</span><span class="p">,</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;page_title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;New LinkedIn News Item&#39;</span><span class="p">,</span>
                <span class="s1">&#39;page_secondary_title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Campaign &quot;&#39;</span><span class="o">.</span><span class="nv">$campaign</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;form&#39;</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">createView</span><span class="p">(),</span>
            <span class="p">));</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <em>createAction()</em> method begins by initializing CampaignChain&#8217;s Activity Wizard,
which takes care of presenting the user with a form that lists available
campaigns and activities. Based on the information received in the form,
the Activity Wizard gets references to the correct Campaign and Activity.
Since by design this Activity has only one Operation, the <em>setEqualsOperation()</em>
method is used to tell CampaignChain that the Activity and the Operation are to
be treated as the same entity.</p>
<p>The controller then initializes and renders the Form object created earlier
using the <em>createForm()</em> method, so that the user can enter the necessary details
for the Activity - in this case, the news item to be posted. If the form
input is valid, the script creates a new Operation object with the same data
as the Activity object. The Operation is then added to the Activity with
the Activity object&#8217;s <em>addOperation()</em> method.</p>
<p>At the same time, once the Operation succeeds, a new Location will be created
representing the news item on LinkedIn. Therefore, the controller invokes
the Location service and defines basic data for the Location. This Location
record is by necessity incomplete at this stage as the news item has yet
to be published on LinkedIn; if you refer to the Job created earlier, you
will see that the Job updates the Location record with the URL to the news
item once it is executed.</p>
<p>Once all the relationships are established, the data is saved to the CampaignChain
database and a success message is displayed to the user. The final execution
of the operation is handled by the CampaignChain job scheduler at the appropriate
time. The above code however demonstrates how the operation can be executed
immediately if required, by invoking the Job service and calling the Job&#8217;s
<em>execute()</em> method.</p>
<p>In a similar vein, you can handle the &#8216;edit&#8217; route by defining an
<em>editAction()</em> method, which takes care of editing an existing activity/operation.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// src/Acme/CampaignChain/Activity/LinkedInBundle/Controller/ShareNewsItemController.php</span>

<span class="k">namespace</span> <span class="nx">CampaignChain\Activity\LinkedInBundle\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CampaignChain\CoreBundle\Entity\Location</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">CampaignChain\CoreBundle\Entity\Medium</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Controller\Controller</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Session\Session</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">CampaignChain\CoreBundle\Entity\Operation</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Response</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Acme\CampaignChain\Operation\LinkedInBundle\Form\Type\ShareNewsItemOperationType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Serializer\Serializer</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Serializer\Encoder\JsonEncoder</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Serializer\Normalizer\GetSetMethodNormalizer</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ShareNewsItemController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">editAction</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$activityService</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain.core.activity&#39;</span><span class="p">);</span>
        <span class="nv">$activity</span> <span class="o">=</span> <span class="nv">$activityService</span><span class="o">-&gt;</span><span class="na">getActivity</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
        <span class="nv">$campaign</span> <span class="o">=</span> <span class="nv">$activity</span><span class="o">-&gt;</span><span class="na">getCampaign</span><span class="p">();</span>

        <span class="c1">// Get the one operation.</span>
        <span class="nv">$operation</span> <span class="o">=</span> <span class="nv">$activityService</span><span class="o">-&gt;</span><span class="na">getOperation</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
        <span class="nv">$operationService</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;acme.operation.linkedin.news_item&#39;</span><span class="p">);</span>
        <span class="nv">$newsitem</span> <span class="o">=</span> <span class="nv">$operationService</span><span class="o">-&gt;</span><span class="na">getNewsItemByOperation</span><span class="p">(</span><span class="nv">$operation</span><span class="p">);</span>

        <span class="nv">$activityType</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain.core.form.type.activity&#39;</span><span class="p">);</span>
        <span class="nv">$activityType</span><span class="o">-&gt;</span><span class="na">setBundleName</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">BUNDLE_NAME</span><span class="p">);</span>
        <span class="nv">$activityType</span><span class="o">-&gt;</span><span class="na">setModuleIdentifier</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">MODULE_IDENTIFIER</span><span class="p">);</span>
        <span class="nv">$shareNewsItemOperation</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ShareNewsItemOperationType</span><span class="p">(</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">(),</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;service_container&#39;</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="nv">$shareNewsItemOperation</span><span class="o">-&gt;</span><span class="na">setNewsItem</span><span class="p">(</span><span class="nv">$newsitem</span><span class="p">);</span>
        <span class="nv">$operationForms</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;identifier&#39;</span> <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">OPERATION_IDENTIFIER</span><span class="p">,</span>
            <span class="s1">&#39;form&#39;</span> <span class="o">=&gt;</span> <span class="nv">$shareNewsItemOperation</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;LinkedIn Message&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="nv">$activityType</span><span class="o">-&gt;</span><span class="na">setOperationForms</span><span class="p">(</span><span class="nv">$operationForms</span><span class="p">);</span>
        <span class="nv">$activityType</span><span class="o">-&gt;</span><span class="na">setCampaign</span><span class="p">(</span><span class="nv">$campaign</span><span class="p">);</span>

        <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createForm</span><span class="p">(</span><span class="nv">$activityType</span><span class="p">,</span> <span class="nv">$activity</span><span class="p">);</span>

        <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">handleRequest</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// Get the status data from request.</span>
            <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">OPERATION_IDENTIFIER</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">();</span>

            <span class="nv">$repository</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>

            <span class="c1">// The activity equals the operation.</span>
            <span class="c1">// Thus, we update the operation with the same data.</span>
            <span class="nv">$activityService</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain.core.activity&#39;</span><span class="p">);</span>
            <span class="nv">$operation</span> <span class="o">=</span> <span class="nv">$activityService</span><span class="o">-&gt;</span><span class="na">getOperation</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
            <span class="nv">$operation</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="nv">$activity</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">());</span>
            <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$operation</span><span class="p">);</span>

            <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$status</span><span class="p">);</span>

            <span class="nv">$hookService</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain.core.hook&#39;</span><span class="p">);</span>
            <span class="nv">$activity</span> <span class="o">=</span> <span class="nv">$hookService</span><span class="o">-&gt;</span><span class="na">processHooks</span><span class="p">(</span>
              <span class="nx">self</span><span class="o">::</span><span class="na">BUNDLE_NAME</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">MODULE_IDENTIFIER</span><span class="p">,</span> <span class="nv">$activity</span><span class="p">,</span> <span class="nv">$form</span>
            <span class="p">);</span>
            <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$activity</span><span class="p">);</span>

            <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>


            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getFlashBag</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span>
                <span class="s1">&#39;success&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Your LinkedIn activity &lt;a href=&quot;&#39;</span><span class="o">.</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span>
                  <span class="s1">&#39;campaignchain_core_activity_edit&#39;</span><span class="p">,</span>
                  <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$activity</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">())</span>
                <span class="p">)</span><span class="o">.</span><span class="s1">&#39;&quot;&gt;&#39;</span><span class="o">.</span><span class="nv">$activity</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span>
                <span class="s1">&#39;&lt;/a&gt; was edited successfully.&#39;</span>
            <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain_hook_campaignchain_due&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">has</span><span class="p">(</span><span class="s1">&#39;execution_choice&#39;</span><span class="p">)</span>
              <span class="o">&amp;&amp;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;campaignchain_hook_campaignchain_due&#39;</span><span class="p">)</span>
                      <span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;execution_choice&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;now&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$job</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;acme.operation.linkedin.job.share_news_item&#39;</span><span class="p">);</span>
                <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$operation</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">());</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span><span class="s1">&#39;campaignchain_core_activities&#39;</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span>
            <span class="s1">&#39;CampaignChainCoreBundle:Base:new.html.twig&#39;</span><span class="p">,</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;page_title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Edit LinkedIn News Item&#39;</span><span class="p">,</span>
                <span class="s1">&#39;page_secondary_title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Campaign &quot;&#39;</span><span class="o">.</span><span class="nv">$campaign</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;form&#39;</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">createView</span><span class="p">(),</span>
            <span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <em>editAction()</em> action method is very similar to the <em>createAction()</em>
method described previously, with the primary difference being that it uses
the identifier passed in the URL string to retrieve a specific activity or
operation and pre-populate the input form with the details of that activity
or operation.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <em>editModalAction()</em> and <em>editApiAction()</em> method implement functionality
similar to that of the <em>editAction()</em> method. They are not included here
but can be viewed in <a class="reference external" href="https://github.com/CampaignChain/activity-linkedin">the source code of the corresponding LinkedIn bundle
on Github</a>.</p>
</div>
<p>It&#8217;s important to note that all the action methods described above use CampaignChain&#8217;s
base views, and it is not necessary to create new views unless you specifically
wish to override the base views.</p>
<p>At this point, your Activity and Operation bundles are complete. Once you
add your modules to CampaignChain through the module installer, you should be able
to connect to a new LinkedIn location and begin posting news items to it.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Connect A New Online Channel</a><ul>
<li><a class="reference internal" href="#assumptions-and-prerequisites">Assumptions and Prerequisites</a></li>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#connect-channels-and-locations">Connect Channels and Locations</a><ul>
<li><a class="reference internal" href="#generate-channel-and-location-bundles">1. Generate Channel and Location bundles</a></li>
<li><a class="reference internal" href="#create-configuration-files">2. Create Configuration Files</a></li>
<li><a class="reference internal" href="#define-channel-routes">3. Define Channel Routes</a></li>
<li><a class="reference internal" href="#add-controllers-and-views">4. Add Controllers and Views</a></li>
<li><a class="reference internal" href="#add-a-channel-icon">5. Add a Channel Icon</a></li>
</ul>
</li>
<li><a class="reference internal" href="#define-activities-and-operations">Define Activities and Operations</a><ul>
<li><a class="reference internal" href="#generate-activity-and-operation-bundles">1. Generate Activity and Operation bundles</a></li>
<li><a class="reference internal" href="#define-configuration-files-for-the-activity-and-operation-bundles">2. Create Configuration Files</a></li>
<li><a class="reference internal" href="#understand-the-linkedin-share-api">3. Understand the LinkedIn Share API</a></li>
<li><a class="reference internal" href="#create-an-entity-and-entity-manager">4. Create An Entity and Entity Manager</a></li>
<li><a class="reference internal" href="#create-an-input-form-for-entity-data">5. Create an Input Form for Entity Data</a></li>
<li><a class="reference internal" href="#create-an-api-client-and-job-processor">6. Create an API Client and Job Processor</a></li>
<li><a class="reference internal" href="#create-activity-and-operation-routes">7. Create Activity and Operation Routes</a></li>
<li><a class="reference internal" href="#create-an-activity-controller">8. Create an Activity Controller</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">The Developer Cookbook</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../../administrator/index.html"
                        title="next chapter">The Administrator Handbook</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../administrator/index.html" title="The Administrator Handbook"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="The Developer Cookbook"
             >previous</a> |</li>
        <li><a href="../../index.html">CampaignChain 1.0.0-alpha.3 documentation</a> &raquo;</li>
          <li><a href="index.html" >The Developer Cookbook</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
    </div>
  </body>
</html>